---
x-k8s:
  - apiVersion: v1
    kind: Secret
    metadata:
      name: &name htpasswd
      namespace: ${COMPOSE_PROJECT_NAME}
    type: kubernetes.io/basic-auth
    stringData:
      username: "a"
      password: ""

  - apiVersion: traefik.io/v1alpha1
    kind: Middleware
    metadata:
      name: auth
      namespace: ${COMPOSE_PROJECT_NAME}
    spec:
      basicAuth:
        secret: *name

services:
  redlib:
    image: quay.io/redlib/redlib:latest
    labels:
      kompose.service.group: &warp redlib
      kompose.service.expose: reddit.${DOMAIN}
      traefik.ingress.kubernetes.io/router.middlewares: ${COMPOSE_PROJECT_NAME}-auth@kubernetescrd
    environment:
      REDLIB_AUTOPLAY_VIDEOS: on
      REDLIB_DEFAULT_AUTOPLAY_VIDEOS: on
      REDLIB_DEFAULT_BLUR_NSFW: on
      REDLIB_DEFAULT_COMMENT_SORT: top
      REDLIB_DEFAULT_DISABLE_VISIT_REDDIT_CONFIRMATION: on
      REDLIB_DEFAULT_HIDE_HLS_NOTIFICATION: on
      REDLIB_DEFAULT_USE_HLS: on
      REDLIB_ENABLE_RSS: on
      REDLIB_FULL_URL: https://reddit.${DOMAIN}
      REDLIB_REMOVE_DEFAULT_FEEDS: on
      REDLIB_ROBOTS_DISABLE_INDEXING: on
    ports:
      - 8080
    volumes:
      - ./redlib.toml:/redlib.toml:ro

  warp:
    image: docker.io/caomingjun/warp:latest
    labels:
      kompose.service.group: *warp
    cap_add:
      - NET_ADMIN
    volumes:
      - data:/var/lib/cloudflare-warp

volumes:
  data:
