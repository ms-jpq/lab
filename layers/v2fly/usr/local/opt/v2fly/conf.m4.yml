---
# m4_include([layers/v2fly/usr/local/opt/v2fly/vars.m4.yml])
_:
  s: &s-PROTOCOL
  c: &c-PROTOCOL

  s-shadowsocks: &s-shadowsocks
    networks: tcp,udp
    method: &ss-method AES_256_GCM
    password: &password m4_esyscmd(./libexec/uuidgen.py m5_assert([ENV_V2R_SEED]))

  s-trojan: &s-trojan
    users:
      - *password

  s-vmess: &s-vmess
    users:
      - *password

  c-shadowsocks: &c-shadowsocks
    method: *ss-method
    password: *password

  c-trojan: &c-trojan
    password: *password

  c-vmess: &c-vmess
    uuid: *password

  # TODO: API
  api:
    tag: &api api
    services:
      - StatsService

server:
  log:
    access: &stdout
      type: Console
      level: Debug
    error:
      <<: *stdout

  services: &services
    stats: {}
    policy:
      system:
        stats:
          inboundDownlink: true
          inboundUplink: true
          outboundDownlink: true
          outboundUplink: true

  router:
    domainStrategy: IpIfNonMatch
    rule:
      - tag: *api
        inboundTag:
          - *api
      - tag: &die blocked
        geoip:
          - code: private

  outbounds:
    - protocol: freedom
    - protocol: blackhole
      tag: *die

  inbounds:
    # - tag: *api
    #   protocol: dokodemo-door
    #   port: 2020
    #   settings:
    #     networks: tcp,udp

    # m4_pushdef([PORT], PORT_BEGIN)
    # m5_for([PROTOCOL], [
    # m5_for([TRANSPORT], [
    # m4_pushdef([TRANS], [m4_regexp(TRANSPORT, [\(^[^@]+\)], [\1])])
    - listen: 127.0.0.53
      port: "PORT"
      protocol: PROTOCOL
      streamSettings:
        transport: TRANS
      settings:
        <<: *s-PROTOCOL
    # m4_pushdef([PORT], m4_incr(PORT))
    # ], TRANSPORTS)
    # ], PROTOCOLS)

client:
  log:
    access:
      <<: *stdout
    error:
      <<: *stdout

  services:
    <<: *services
    backgroundObservatory:
      subjectSelector: &ldrs
        - &ldr ldr-
      probeInterval: 100
    burstObservatory:
      subjectSelector: *ldrs

  router:
    balancingRule:
      - tag: *ldr
        outboundSelector: *ldrs
        strategy: random

    rule:
      - tag: *api
        inboundTag:
          - *api
      - tag: &local passthrough
        geoip:
          - filePath: geoip.dat
            code: private
      - tag: *local
        geoip:
          - filePath: geoip.dat
            code: cn
      - tag: *local
        geoDomain:
          - filePath: geosite.dat
            code: cn

      - balancingTag: *ldr
        portList: 1-65535

  inbounds:
    # - tag: *api
    #   protocol: dokodemo-door
    #   port: 2021
    #   settings:
    #     networks: tcp,udp

    - protocol: dokodemo-door
      port: 30001
      settings:
        networks: tcp,udp
        followRedirect: true

    - protocol: socks
      port: 30002
      settings:
        udpEnabled: true

    - protocol: http
      port: 30003

  outbounds:
    - protocol: freedom
      tag: *local

    # m4_pushdef([PORT], PORT_BEGIN)
    # m5_for([PROTOCOL], [
    # m5_for([TRANSPORT], [
    # m4_pushdef([TRANS], [m4_regexp(TRANSPORT, [\(^[^@]+\)], [\1])])
    # m4_pushdef([XPORT], [m4_regexp(TRANSPORT, [\([^@]+$\)], [\1])])
    - tag: ldr-PROTOCOL-TRANS
      protocol: PROTOCOL
      streamSettings:
        transport: TRANS
        # m4_ifelse(XPORT, [tcp], [
        security: utls
        securitySettings:
          imitate: randomized
        # ])
      mux:
        enabled: true
      settings:
        address: PROTOCOL-TRANS.m5_assert([ENV_V2R_DOMAIN])
        port: 443
        <<: *c-PROTOCOL
    # m4_pushdef([PORT], m4_incr(PORT))
    # ], TRANSPORTS)
    # ], PROTOCOLS)
