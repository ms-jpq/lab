# NL

define ACCEPT  = 0xb00b0000
define PROXIED = 0x00000069

define WG    = 51820
define SQUID = 8888

add element inet user hijack { tcp . domain: domain, tcp . domain-s: domain-s, udp . domain: domain, udp . ntp: ntp }

add element inet user internal_ports { udp . ntp }
add element inet user external_ports { tcp . http, udp . $WG }

add element inet user external_ifs { m5_assert([ENV_WAN_IF]) }
add element inet user internal_ifs { wg, m5_join([,], m5_or([ENV_LAN_IFS], [])) }

table inet user {
  chain premangle {
    type filter hook prerouting priority mangle
    mark & $PROXIED != $PROXIED iifname @internal_ifs ip  daddr != @local_v4 meta l4proto { tcp } th dport { http, ftp, gopher } mark set mark | $ACCEPT | $PROXIED tproxy ip  to :$SQUID
    mark & $PROXIED != $PROXIED iifname @internal_ifs ip6 daddr != @local_v6 meta l4proto { tcp } th dport { http, ftp, gopher } mark set mark | $ACCEPT | $PROXIED tproxy ip6 to :$SQUID
  }

  chain output {
    counter skgid proxy mark set mark | $PROXIED
  }
}
