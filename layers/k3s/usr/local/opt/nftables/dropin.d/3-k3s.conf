#

add element inet user internal_ports { tcp . 6443 }

table inet user {
  set k3s_ifs {
    type  ifname
    flags interval
    elements = { "veth*", "cni*", "flannel*" }
  }

  chain forward {
    iifname @k3s_ifs ip  saddr @internal_v4 mark set mark | 0xb00b0000 comment "Allow local IP4 traffic"
    iifname @k3s_ifs ip6 saddr @internal_v6 mark set mark | 0xb00b0000 comment "Allow local IP6 traffic"

    th dport { 8008 } mark & 0xb00b0000 != 0xb00b0000 counter reject comment "Forbid k8s load balancers"
  }
}
