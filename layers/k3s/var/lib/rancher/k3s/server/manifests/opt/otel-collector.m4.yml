# https://github.com/open-telemetry/opentelemetry-helm-charts/blob/main/charts/opentelemetry-collector/values.yaml
---
apiVersion: helm.cattle.io/v1
kind: HelmChart
metadata:
  name: &chart opentelemetry-collector
  namespace: kube-system
spec:
  chart: *chart
  createNamespace: true
  repo: https://open-telemetry.github.io/opentelemetry-helm-charts
  targetNamespace: *chart
  valuesContent: |-
    mode: daemonset
    image:
      repository: ghcr.io/open-telemetry/opentelemetry-collector-releases/opentelemetry-collector-k8s
    presets:
      logsCollection:
        enabled: true
        includeCollectorLogs: true
      kubernetesAttributes:
        enabled: true
    config:
      processors:
        &meta transform:
          log_statements:
            - >-
              set(resource.attributes[["k8s.cluster.name"]], "k3s.m5_assert([ENV_MACHINE])")
            - >-
              delete_key(log.attributes, "log.file.path")
            - >-
              delete_key(log.attributes, "logtag")
      exporters:
        &out otlphttp:
          endpoint: m5_assert([ENV_OTLP_ENDPOINT])/otlp
          headers:
            authorization: >-
              Basic m5_esyscmd(printf -- %s 'm5_assert([ENV_OTLP_PASSWORD])' | jq --raw-input --join-output '"loki:\(.)" | @base64')
      service:
        telemetry:
          logs:
            level: warn
        pipelines:
          logs:
            receivers:
              - filelog
            processors:
              - *meta
            exporters:
              - *out
