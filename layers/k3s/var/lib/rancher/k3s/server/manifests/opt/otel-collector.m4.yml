# https://github.com/open-telemetry/opentelemetry-helm-charts/blob/main/charts/opentelemetry-collector/values.yaml
---
apiVersion: helm.cattle.io/v1
kind: HelmChart
metadata:
  name: &chart opentelemetry-collector
  namespace: kube-system
spec:
  chart: *chart
  createNamespace: true
  repo: https://open-telemetry.github.io/opentelemetry-helm-charts
  targetNamespace: *chart
  valuesContent: |-
    mode: daemonset
    image:
      repository: ghcr.io/open-telemetry/opentelemetry-collector-releases/opentelemetry-collector-k8s
    networkPolicy:
      enabled: true
    service:
      enabled: true
    presets:
      logsCollection:
        enabled: true
        includeCollectorLogs: true
      kubernetesAttributes:
        enabled: true
      kubeletMetrics:
        enabled: true
      kubernetesEvents:
        enabled: true
      # clusterMetrics:
      #   enabled: true
    config:
      extensions:
        health_check:
          endpoint: "[[::]]:13133"
      receivers:
        jaeger: null
        &recv otlp:
          protocols:
            grpc: null
            http:
              endpoint: "[[::]]:4318"
        &pc prometheus/cluster:
          config:
            scrape_configs:
              - job_name: cluster-metrics
                scrape_interval: 10s
                static_configs:
                  - targets:
                      - kube-state-metrics.kube-state-metrics.svc.cluster.local:8080
                      # - traefik.kube-system.svc.cluster.local:9090
                      # - metrics-server.kube-system.svc.cluster.local:8080
      processors:
        &meta transform:
          log_statements:
            - >-
              set(resource.attributes[["k8s.cluster.name"]], "m5_assert([ENV_MACHINE]).k3s")
            - >-
              [replace_pattern(resource.attributes["service.name"], "(.*)", "$1.k3s")]
            - >-
              delete_key(resource.attributes, "service.namespace")
            - >-
              delete_key(log.attributes, "log.file.path")
            - >-
              delete_key(log.attributes, "logtag")
      exporters:
        &out otlphttp:
          endpoint: m5_assert([ENV_OTLP_ENDPOINT])
          headers:
            authorization: >-
              Basic m5_esyscmd(printf -- %s 'm5_assert([ENV_OTLP_PASSWORD])' | jq --raw-input --join-output '"otlp:\(.)" | @base64')
      service:
        telemetry:
          logs:
            level: warn
        pipelines:
          traces:
            receivers:
              - *recv
            exporters:
              - *out
          logs:
            receivers:
              - *recv
              - filelog
            processors:
              - *meta
            exporters:
              - *out
          metrics:
            receivers:
              - *pc
              - *recv
              - prometheus
            exporters:
              - *out
