# NL

table inet user {
  set external_ports {
    type  inet_proto . inet_service
    flags interval
    elements = { tcp . ssh, udp . 60000-61000 }
  }

  set internal_ports {
    type  inet_proto . inet_service
    flags interval
    elements = { udp . bootps, udp . dhcpv6-server, udp . domain, udp . mdns, tcp . domain, tcp . domain-s, tcp . http-alt }
  }

  chain input {
    meta nfproto ipv6 udp dport dhcpv6-client mark set $ACCEPT comment "Allow DHCPv6 client"

    iif lo mark set $ACCEPT comment "Allow local traffic"

                          meta l4proto . th dport @external_ports mark set $ACCEPT comment "Allow whitelisted external ports"
    iifname @internal_ifs meta l4proto . th dport @internal_ports mark set $ACCEPT comment "Allow whitelisted internal ports"

    iifname != @external_ifs ip  saddr @local_v4 ct status { dnat } mark set $ACCEPT comment "Allow local DNATed traffic"
    iifname != @external_ifs ip6 saddr @local_v6 ct status { dnat } mark set $ACCEPT comment "Allow local DNATed traffic"
    iifname != @external_ifs ip  saddr @local_v4 meta l4proto . th dport @internal_ports mark set $ACCEPT comment "Allow whitelisted internal ports IPv4"
    iifname != @external_ifs ip6 saddr @local_v6 meta l4proto . th dport @internal_ports mark set $ACCEPT comment "Allow whitelisted internal ports IPv6"
  }
}

