[Unit]
StopWhenUnneeded     = yes

ReloadPropagatedFrom = nftables.service
After                = nftables.service

PartOf               = sys-subsystem-net-devices-%i.device

BindsTo              = 1-ip-alloc@%i.service
After                = 1-ip-alloc@%i.service

After                = 1-vn@%i.service

[Service]
Restart              = on-failure

ProtectSystem        = strict
ReadWritePaths       = %t/dnsmasq %t/local/dnsmasq

PrivateTmp           = yes
RuntimeDirectory     = local/dnsmasq/%I/conf.d local/dnsmasq/%I/hosts.d local/dnsmasq/%I/dhcp.hosts.d local/dnsmasq/%I/dhcp.opts.d

ExecStartPre         =
ExecStart            =
ExecStartPost        =
ExecStop             =

EnvironmentFile      = %t/local/ip/%I.env
EnvironmentFile      = -/usr/local/lib/etc/default/%I.dnsmasq.env
Environment          = RUN=%t/local/dnsmasq/%I
Environment          = IFACE=%I
Environment          = DOMAIN=%I
Environment          = TTL=120
Environment          = HOST=%H

ExecStartPre         = /usr/local/opt/dnsmasq/libexec/networkd.sh %t/systemd/network/0-%I.network %t/local/dnsmasq/%I/conf.d/networkd.conf
ExecStartPre         = /usr/local/opt/dnsmasq/libexec/conf.sh ${RUN}/dnsmasq.conf
ExecStart            = dnsmasq --conf-file=${RUN}/dnsmasq.conf

[Install]
WantedBy             =
