---
on:
  push:

jobs:
  build_linux:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v3

      - run: |-
          gmake build

  build_nt:
    runs-on: windows-latest

    steps:
      - uses: actions/checkout@v3

      - run: |-
          $pacman = Join-Path -Path $Env:GHCUP_MSYS2 'usr' 'bin' 'pacman'
          $argv = @('--sync', '--refresh', '--noconfirm', '--', 'make')
          & $pacman @argv

      - run: |-
          $gmake = Join-Path -Path $Env:GHCUP_MSYS2 'usr' 'bin' 'make'
          & $gmake build

  lint:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v3

      - uses: actions/setup-python@v4
        with:
          python-version: "3.11"

      - uses: actions/setup-node@v3

      - run: |-
          gmake lint

      - run: |-
          LOCAL=1 gmake examples
          LOCAL=1 gmake

      - run: |-
          LOCAL=1 gmake --debug

      - run: |-
          LOCAL=1 ./main.sh --machine all

      - run: |-
          LOCAL=1 ./main.sh --machine all -- --debug

      - run: |-
          gmake fmt
          git diff --exit-code
