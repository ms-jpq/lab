---
x-wallabag: &wallabag
  image: docker.io/wallabag/wallabag:latest
  environment:
    SYMFONY__ENV__DATABASE_DRIVER: pdo_pgsql
    SYMFONY__ENV__DATABASE_HOST:
    SYMFONY__ENV__DATABASE_NAME: wallabag
    SYMFONY__ENV__DATABASE_PASSWORD:
    SYMFONY__ENV__DATABASE_PORT: 5432
    SYMFONY__ENV__DATABASE_USER:
    SYMFONY__ENV__DOMAIN_NAME: https://pocket.${DOMAIN}
    SYMFONY__ENV__MAILER_DSN: smtp://host.home.arpa:25

services:
  wallabag-init:
    <<: *wallabag
    command:
      - sh
      - -c
      - "/entrypoint.sh migrate || :"

  wallabag:
    <<: *wallabag
    restart: unless-stopped
    depends_on:
      wallabag-init:
        condition: service_completed_successfully
    labels:
      traefik.enable: true
      traefik.http.routers.wallabag.rule: HostRegexp(`^pocket\.`)
      traefik.http.services.wallabag.loadbalancer.server.port: 80
    # healthcheck:
    #   test:
    #     - CMD
    #     - curl
    #     - --fail
    #     - --location
    #     - --no-progress-meter
    #     - --output
    #     - /dev/null
    #     - --max-time
    #     - "30"
    #     - --
    #     - 127.0.0.1:80

  redis:
    image: ghcr.io/valkey-io/valkey:latest
    healthcheck:
      test:
        - CMD
        - redis-cli
        - incr
        - ping
    volumes:
      - data:/data

volumes:
  data:
